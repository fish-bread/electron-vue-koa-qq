<!--suppress ALL -->
<script setup>
import { close, setFullScreen, shrink } from '../../function/Window/TopBorder'
import { ref, onMounted, onUnmounted } from 'vue'
const isMicrophone = ref(true)
import { selectedUserUid, initialize_user } from '../../function/user'
import {
  localVideo,
  remoteVideo,
  ws,
  connectWebSocket,
  initializeWebRTC,
  peerConnection,
  createAndSendOffer
} from '../../axios/webRTCAxios'

onMounted(async () => {
  //接收uid和ws
  window.api.receiveSelectedUserUid((event, uid) => {
    selectedUserUid.value = uid
    console.log('Received selectedUserUid:', selectedUserUid.value)
  })
  // 初始化 WebRTC及用户
  await initialize_user()
  //启动webrtc
  connectWebSocket()
  // 初始化 WebRTC
  await initializeWebRTC()
  //发送offer
  createAndSendOffer(selectedUserUid.value)
})
onUnmounted(() => {
  ws.value.close()
  peerConnection.value.close()
})
</script>

<template>
  <div class="rtc-box">
    <!--头部-->
    <div class="rtc-box-top">
      <!--按钮-->
      <div class="rtc-box-top-button">
        <button class="gray" @click="shrink">
          <svg
            t="1741916524280"
            class="icon"
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            p-id="3514"
            width="200"
            height="200"
          >
            <path
              d="M819.2 477.866667h-597.333333c-17.066667 0-34.133333 12.8-34.133334 34.133333s12.8 34.133333 34.133334 34.133333h597.333333c17.066667 0 34.133333-12.8 34.133333-34.133333s-12.8-34.133333-34.133333-34.133333z"
              p-id="3515"
            ></path>
          </svg>
        </button>
        <button class="gray" @click="setFullScreen">
          <svg
            t="1741916508767"
            class="icon"
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            p-id="3348"
            width="200"
            height="200"
          >
            <path
              d="M832 93.866667h-640c-51.2 0-93.866667 42.666667-93.866667 93.866666v640c0 51.2 42.666667 93.866667 93.866667 93.866667h640c51.2 0 93.866667-42.666667 93.866667-93.866667v-640c4.266667-46.933333-42.666667-93.866667-93.866667-93.866666z m29.866667 738.133333c0 17.066667-12.8 34.133333-34.133334 34.133333h-640c-17.066667 0-34.133333-12.8-34.133333-34.133333v-640c0-17.066667 12.8-34.133333 34.133333-34.133333h640c17.066667 0 34.133333 12.8 34.133334 34.133333v640z"
              p-id="3349"
            ></path>
          </svg>
        </button>
        <button class="gray" @click="close">
          <svg
            t="1741916485573"
            class="icon"
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            p-id="3182"
            width="200"
            height="200"
          >
            <path
              d="M558.933333 512l320-320c12.8-12.8 12.8-34.133333 0-46.933333s-34.133333-12.8-46.933333 0L512 465.066667 192 149.333333c-12.8-12.8-34.133333-12.8-46.933333 0s-12.8 34.133333 0 46.933334l320 320-320 320c-12.8 12.8-12.8 34.133333 0 46.933333 4.266667 4.266667 12.8 8.533333 21.333333 8.533333s17.066667-4.266667 21.333333-8.533333l320-320 320 320c4.266667 4.266667 12.8 8.533333 21.333334 8.533333s17.066667-4.266667 21.333333-8.533333c12.8-12.8 12.8-34.133333 0-46.933333L558.933333 512z"
              p-id="3183"
            ></path>
          </svg>
        </button>
      </div>
    </div>
    <!--中间-->
    <div class="rtc-box-center">
      <video id="localVideo" ref="localVideo" autoplay muted></video>
      <video id="remoteVideo" ref="remoteVideo" autoplay></video>
    </div>
    <!--底部-->
    <div class="rtc-box-bottom">
      <button class="rtc-box-bottom-button">
        <!--打开麦克风状态-->
        <div v-show="isMicrophone === true" class="rtc-box-bottom-button-svg white">
          <svg
            t="1742714269708"
            class="icon"
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            p-id="4173"
            width="200"
            height="200"
          >
            <path
              d="M464.3328 834.9696C272.1792 811.6736 128 653.2096 128 465.4592h96a275.0464 275.0464 0 0 0 84.3264 197.7344 292.864 292.864 0 0 0 203.6736 81.92h1.9456c158.3104-1.024 286.0544-125.7472 286.0544-279.2448H896c0 187.4944-143.8208 345.8048-335.6672 369.408l0.4608 142.4384-96 0.256zM512 93.0816c-53.0432 0-96 41.6768-96 93.0816v279.296c0 51.2 42.9568 93.0816 96 93.0816s96-41.6768 96-93.0816V186.1632a91.8528 91.8528 0 0 0-28.1088-65.6896A97.5872 97.5872 0 0 0 512 93.2352zM512 0c106.0352 0 192 83.3536 192 186.1632v279.296c0 102.8096-85.9648 186.1632-192 186.1632s-192-83.3536-192-186.1632V186.1632C320 83.3536 405.9648 0 512 0z m0 0"
              p-id="4174"
            ></path>
            <path d="M320 930.9184h384V1024h-384z" p-id="4175"></path>
          </svg>
        </div>
        <!--关闭麦克风状态-->
        <div v-show="isMicrophone === false" class="rtc-box-bottom-button-svg">
          <svg
            t="1742714278386"
            class="icon"
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            p-id="1760"
            width="200"
            height="200"
          >
            <path
              d="M348.059755 959.775056c-10.96595-4.376558-17.889634-11.723875-21.042625-22.330092-5.465225-18.3819-0.010058-34.898867 14.825983-44.897443 6.662758-4.489567 7.54375-4.54755 69.452793-4.54755h62.704243v-79.754892l-9.500392-1.340717c-94.618151-13.353917-179.366711-66.700359-233.511904-146.986569-31.141192-46.176626-49.366892-98.613085-55.048667-158.379702-3.362442-35.372201 0.141408-48.367567 15.904-58.990351 5.273525-3.554142 9.546542-4.54755 19.551625-4.54755 13.638509 0 20.972217 2.713975 27.855668 10.309792 7.6325 8.423558 9.10575 13.79175 10.811525 39.412692 0.925367 13.902392 3.124592 32.243467 4.887166 40.756959 19.051667 92.037893 85.044393 166.080244 174.050586 195.281953 51.038351 16.744759 116.202152 16.70275 165.785003-0.107684l17.784908-6.029675 26.714934 26.660501c14.69345 14.662684 26.715525 27.218442 26.715525 27.901817 0 0.683375-8.490417 4.98065-18.86825 9.5495-20.953875 9.225858-60.378401 20.840275-82.632168 24.342942l-14.499975 2.28265v79.638334h62.704834c61.909043 0 62.789443 0.057392 69.452201 4.54755 13.868667 9.345967 20.035017 25.886009 15.679759 42.058626-3.14885 11.695475-8.462608 18.371842-18.481892 23.222325-8.521183 4.1251-10.395583 4.170067-167.486044 4.044634-99.403551-0.079283-160.717969-0.864425-163.808836-2.09805z m544.940391-11.5801c-3.300317-2.084442-188.867103-186.805736-412.371556-410.492423-366.139905-366.438697-406.506956-407.455989-407.743539-414.31459-3.512133-19.481217 2.409858-34.916617 17.525167-45.680217 8.457875-6.021983 28.113042-7.545525 37.835309-2.931708 3.882517 1.84245 180.260128 176.766336 414.129989 410.716664 367.101955 367.228572 407.502731 408.259473 408.739315 415.119256 2.470208 13.701817 0.021892 26.843917-6.51425 34.966909-10.309792 12.812542-17.434642 16.4223-32.396118 16.413425-9.506308-0.005917-14.884559-1.06855-19.204317-3.797316z m-137.950635-298.14498l-25.892517-25.9505 4.4872-7.549667c24.889642-41.874617 40.227417-91.444451 40.395451-130.550069 0.101175-23.587384 4.556425-34.391217 17.939925-43.499334 9.466075-6.44325 30.58325-6.417808 40.177126 0.047334 15.739517 10.606808 19.26585 23.6288 15.92175 58.801017-5.801883 61.030418-23.566084 111.45521-56.417784 160.151153-5.380617 7.975667-9.99325 14.499975-10.250626 14.499975-0.257375 0-12.1197-11.677134-26.360525-25.9505z m-271.122971 9.97195c-66.130584-10.580183-120.530193-52.789684-145.017502-112.52021-9.950058-24.268392-13.027317-41.905976-14.221892-81.502084l-1.115883-36.999876 40.968776 40.736251c30.670225 30.496867 41.521984 42.562134 43.169775 48.000142 3.285525 10.839333 17.158334 30.874942 28.336101 40.925584 5.430317 4.882433 17.3169 12.567 26.413775 17.077275 14.998159 7.435475 19.96165 11.62625 53.235801 44.945959 33.443959 33.490109 36.279817 36.864384 32.000292 38.078484-7.962058 2.260167-52.071401 3.129917-63.769834 1.258475z m161.594228-119.521993l-27.425526-27.500075 3.020459-11.520934c2.576708-9.828767 2.936442-30.975525 2.451866-143.999835l-0.568-132.478902-5.2753-14.431934c-12.381217-33.867-40.161151-59.780818-74.516276-69.510184-16.643584-4.713808-48.322601-4.341058-64.860867 0.76325-28.432542 8.774417-54.249917 30.2247-66.412218 55.178834-9.674342 19.849825-11.9351 32.520959-11.9351 66.899751v31.059542l-37.000467-36.960234c-42.479301-42.432559-39.631017-35.443792-28.436092-69.770518 18.9712-58.170301 66.708051-102.60861 128.436635-119.561043 17.5441-4.817942 23.56135-5.492442 49.000059-5.492442 25.369484 0 31.473709 0.680417 48.759251 5.433867 65.447801 17.9985 113.347952 65.306393 131.142918 129.52116 7.344358 26.503709 8.426517 52.326409 7.580434 180.869545-0.923 140.272335-0.509425 136.253144-18.043467 175.500169-3.316883 7.425417-6.58525 13.500059-7.262117 13.500058-0.676867 0-13.572242-12.3753-28.656192-27.500075z"
              fill="#333333"
              p-id="1761"
            ></path>
          </svg>
        </div>
        <div v-show="isMicrophone === true">关闭麦克风</div>
        <div v-show="isMicrophone === false">打开麦克风</div>
      </button>
      <button class="rtc-box-bottom-button">
        <div class="rtc-box-bottom-button-svg">
          <svg
            t="1742708500672"
            class="icon"
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            p-id="10143"
            width="200"
            height="200"
          >
            <path
              d="M602.224 891h-480.96C54.392 891 0 836.64 0 769.736v-515.44c0-66.872 54.392-121.304 121.264-121.304h480.96c66.864 0 121.296 54.424 121.296 121.304v88.312l253.032-146.104a31.76 31.76 0 0 1 31.632 0A31.632 31.632 0 0 1 1024 223.904v576.232a31.704 31.704 0 0 1-15.816 27.424 31.76 31.76 0 0 1-31.632 0L723.52 681.464v88.272c0 66.904-54.424 121.264-121.296 121.264z m-480.96-694.744c-32 0-58.008 26.04-58.008 58.04v515.44c0 32 26.008 58.008 58.008 58.008h480.96c32 0 58.04-26.008 58.04-58.008V626.664c0-11.304 6.024-21.752 15.816-27.432a31.744 31.744 0 0 1 31.624 0l253.04 146.104V278.688l-253.04 146.104a31.744 31.744 0 0 1-31.624 0 31.632 31.632 0 0 1-15.816-27.4V254.296c0-32-26.04-58.04-58.04-58.04h-480.96z"
              fill="#2c2c2c"
              p-id="10144"
            ></path>
          </svg>
        </div>
        <div>关闭视频</div>
      </button>
      <button class="rtc-box-bottom-button">
        <div class="rtc-box-bottom-button-svg red" @click="close">
          <svg
            t="1742714948455"
            class="icon"
            viewBox="0 0 1024 1024"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
            p-id="5359"
            width="200"
            height="200"
          >
            <path
              d="M908.7 447.3c-46-55.1-119.2-92.2-217.7-110.1-75.8-13.8-144.6-12.1-170.6-11.5-3.2 0.1-5.9 0.1-7.3 0.1s-4.2-0.1-7.3-0.1c-25.9-0.6-94.8-2.3-170.6 11.5-98.4 17.9-171.7 55-217.7 110.1-41.9 50.2-53.9 96.5-51.3 123.1 1.5 15.2 7.8 42.6 18 66.8 15.8 37.5 36.8 58.2 62.4 61.6 2.8 0.4 5.8 0.6 8.9 0.6 30.4 0 71.4-16.9 88.7-24.8 29.8-13.5 67.5-34.3 78.1-57.1 10.7-23 11-41.1 11.2-54.4 0.2-10.5 0.4-14.6 3.4-19.6 1.3-1.3 15.2-13.4 78.4-23.4 40.3-6.3 81.3-8.7 97.7-8.7s57.3 2.4 97.7 8.7c63.2 9.9 77 22.1 78.4 23.4 3 5 3.2 9 3.4 19.6 0.2 13.2 0.5 31.3 11.2 54.4 10.6 22.8 48.3 43.7 78.1 57.1 17.4 7.8 58.4 24.8 88.7 24.8 3.1 0 6.1-0.2 8.9-0.6 25.6-3.4 46.6-24.1 62.4-61.6 10.2-24.3 16.5-51.7 18-66.8 2.8-26.6-9.2-72.9-51.1-123.1z m-4.5 117.5c-0.8 8.2-5 28.3-12.7 47.6-9 22.4-17.2 29.9-19.6 30.9-6.8 0.8-29.6-3.4-63-18-33.1-14.5-51-27.9-54.8-32.4-5.2-11.7-5.4-20.1-5.6-30.7-0.2-13.4-0.5-30-12.1-48.7-8.6-13.8-24.4-24.3-49.5-33-16.8-5.8-38.2-10.9-63.4-15-45-7.4-90.6-10-110.4-10s-65.4 2.7-110.4 10c-25.3 4.1-46.6 9.2-63.4 15-25.1 8.7-40.8 19.2-49.5 33-11.6 18.6-11.9 35.3-12.1 48.7-0.2 10.6-0.3 19-5.6 30.7-3.8 4.5-21.7 17.9-54.8 32.4-33.4 14.6-56.2 18.8-63 18-2.4-1-10.7-8.5-19.6-30.9-7.7-19.3-11.9-39.5-12.7-47.6-0.9-8.8 4.3-40.6 38.5-81.6 37.4-44.8 99.5-75.4 184.7-90.9 70.1-12.8 134.8-11.2 159.2-10.6 3.8 0.1 6.6 0.2 8.7 0.2s4.9-0.1 8.7-0.2c24.4-0.6 89-2.1 159.2 10.6 85.2 15.5 147.3 46.1 184.7 90.9 34.2 41 39.4 72.8 38.5 81.6z"
              fill="#2c2c2c"
              p-id="5360"
            ></path>
          </svg>
        </div>
        <div>挂断</div>
      </button>
    </div>
  </div>
</template>

<style scoped>
.rtc-box {
  background-color: #0093f5;
  height: 100vh;
  display: grid;
  grid-template-rows: 33px auto 105px;
  overflow: hidden;
}
.rtc-box-top {
  display: flex;
  flex-direction: row;
  -webkit-app-region: drag;
  background-color: #1a1a1a;
  height: 33px;
  align-items: center;
  justify-content: flex-end;
}
.rtc-box-top-button {
  display: grid;
  grid-template-columns: 20px 20px 20px;
  justify-content: end;
  align-items: center;
  grid-column-gap: 10px;
  box-sizing: border-box;
  padding-right: 5px;
}
.rtc-box-top-button .icon {
  width: 18px;
  height: 18px;
}
.rtc-box-center {
  background-color: khaki;
  display: flex;
  flex-direction: row;
}
.rtc-box-center video {
  width: 45%;
  height: 45%;
}
.rtc-box-bottom {
  background-color: #1a1a1a;
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
}
.rtc-box-bottom-button {
  all: unset;
  display: flex;
  flex-direction: column;
  height: 70px;
  width: 70px;
  font-size: 10px;
  color: white;
  box-sizing: border-box;
  margin-right: 20px;
  align-items: center;
}
.rtc-box-bottom-button-svg {
  width: 43px;
  height: 43px;
  background-color: #484848;
  border-radius: 10px;
  display: grid;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
  margin-bottom: 5px;
}
.rtc-box-bottom-button-svg:hover {
  background-color: #6d6d6d;
}
.rtc-box-bottom-button-svg .icon {
  width: 30px;
  height: 30px;
}
.gray {
  all: unset;
  -webkit-app-region: no-drag;
  width: 20px;
  height: 20px;
  display: grid;
  align-items: center;
  justify-content: center;
}
.gray .icon path {
  fill: #8c8c8c !important;
}
.gray:hover {
  background-color: #484848;
}
.red {
  background-color: #ff3352;
}
.red:hover {
  background-color: #ff5c75;
}
.white {
  background-color: #fff;
}
.white:hover {
  background-color: #f5f5f5;
}
</style>
